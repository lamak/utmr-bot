# Диагностика УТМ
Рабочий УТМ должен быть доступен на `localhost:8080`, на странице не должно быть сообщений об ошибках.
Проблемы могут быть с ключом, со связью (допустимо 3 дня работы в офлайн)

## Работа с ботом
Большинство диагностических функций УТМ выполняет бот при запросе проверки хоста:
- проверка доступности по сети
- проверка работоспособности Рутокена
- необходимость обновления настроек (можно выполнить команду `/filter имя-хоста`)
- состояние лицензии (опциональна, не требуется при продаже пива)
- доступность сети УТМ (входящие документы)
- работоспособность почтового модуля Супермаг (исходящие документы)

При возникновении ошибок, в соответсвтующих полях указаны рекомендации, или недоступность: например недоступне утм, или недоступен хост, не удалось подписать документ (ошибка рутокена)
Также можно запросить логи 
- `transport_transactions` — подписанные чеки, проверить что УТМ получил \ подписал от кассы, получал ли документы вообще
- `transport_info` — состояние УТМ `transporter`, непосредственно служба подписывающая чеки, в логах обычно ошибка мешающая запуску или работе
- `update` — состояние службы `updater`, вспомогательная служба необходимая для запуска

## Порядок диагностики УТМ
1. Проверить что УТМ доступен
2. Если УТМ недосупен по сети, проверить доступность с хоста (проблема сети)
3. Если УТМ недосутен локальноно, провериить запущены службы
4. Если службы запущены, или запуск невозможен (приводит к остановке), проверить логи УТМ: transport_info, updater
5. Частая причина, что служба transport не может стартовать, т.к. не запущена или недоступна служба updater на 8193 порту, точная ошибка будет логах

## Марка невалидна
1. Проверить ошибки на УТМ через отчет `http://vl20-ws88.severotorg.local/utm_logs`
2. Проверить ошибочную марку из отчета в УТМ `http://vl20-ws88.severotorg.local/mark`
3. Если "штрихкод не найден", обновить настройки УТМ
4. Если обновление не может быть выполнено, проверить доступность mark-utm.egais.ru:8443 например командой `Test-NetConnection -Port 8443 -ComputerName mark-utm.egais.ru`
5. Если недоступен, проверить сеть или проверить с другого сервера (проблема на конкретном утм, или на многих (на чьей стороне))
6. Попробовать установить настройки прокси для УТМ по `c$\utm\transporter\conf\transport.properties` (`proxy` параметры, `пользователь@severotorg.local`)
7. Попробовать перезапустить службу УТМ \ хост

## Недоступен ключ Рутокен*
1. Проверить подключен ли ключ к серверу с УТМ
    Ключ должен определяться в Панели управления Рутокен. Должен быть ключ ГОСТ, RSA (PKI) сертификаты

2. Если ключ не определяется, проверить проброс через USB Redirector.
    _Если на сервере USB Redirector ключ, ключ не определятеся или не может быть расшарен:_
    1. Заново сделать общим
    2. Перезапустить службу и приложение USB Redirector Server
    3. Выполнить `devcon restart usb\*` (devcon не установлен по умолчанию)
    4. При возможности физически переподключить ключ, попробовать другой USB порт
    5. Перезапустить физически сервер с ключом
    _Если после этого ключ не определятся ни на клиенте, ни на сервере - вероятно, ключ нужно заменить_

3. Запустить службы УТМ: transport-updater, transport
    _Если при наличии ключа службы не запускаются, запускаются и останавливаются произвольно, то смотрим лог:_
    `transport-updater : \UTM\updater\l\update.log` (вспомогательная служба УТМ)
    `transport : \UTM\transport\l\transport_info.log`

## HTTP request failed при подписи чека, и работающем УТМ*
1. Проверить адрес сервера УТМ в настройках УКМ, Настройки - Интеграция - ЕГАИС
2. Проверить ping с кассы на сервер УТМ
3. Перезапустить службу transport на УТМ

## Проблемы с обменом Супермага
1. Проверить состояние УТМ, для приема-отправки документов должен быть исправен ключ
2. Проверить на УТМ вкладки входящие, исходящие. Очередь исходящих должна быть пуста, иначе проверить связь
3. Проверить очередь обмена в Супермаге